
# 发版步骤 

1. 完成测试项，评估能否发版
2. 暂停代码提交
3. 数据库备份
4. 打包镜像发到远程
5. 同步数据库变更信息
6. 发版
7. 回归测试
8. 验证通过

## 

## 服务更新 

| 更新项目                             | 更新版本号 |                                                              |
| ------------------------------------ | ---------- | ------------------------------------------------------------ |
| sxsddsj-shield-online-data-collector | 11965      | 新增环境变量`BEIYAN_WEST_ADDRESS`，默认值`http://openapi.dadungou.com:9002/ShieldAuth/ShieldDataV2`，为北延数据http采集接口，生产环境直接使用该默认值。 |
| sxsddsj-shield-data-main             | 11970      |                                                              |

# CK相关命令(王奎清来执行)

> ### 按照顺序执行



1. kafka创建topic`sxsddsj_shield_online_data_all_in_one_4_1`，只需要1个partition

2. clickhouse创建kafka采集表（**需要修改kafka_broker_list**）

```sql
CREATE TABLE sxsddsj.shield_online_data_all_in_one_4_1_kafka
(
    `collectTime` String,
    `cutterHeadTorque` Nullable(Decimal(18, 4)),
    `cutterHeadSpeed` Nullable(Decimal(18, 4)),
    `advancementAngle` Nullable(Decimal(18, 4)),
    `speedReducerTemperatureAlarmValue` Nullable(Decimal(18, 4)),
    `totalPropulsion` Nullable(Decimal(18, 4)),
    `primaryHydraulicOilTankTemperature` Nullable(Decimal(18, 4)),
    `tunnellingRate` Nullable(Decimal(18, 4)),
    `tunnellingRingNumber` Nullable(Decimal(18, 4)),
    `designRingNumber` Nullable(Decimal(18, 4)),
    `propulsionSpeed` Nullable(Decimal(18, 4)),
    `propulsionDisplacement` Nullable(Decimal(18, 4)),
    `frontPointDeviationX` Nullable(Decimal(18, 4)),
    `frontPointDeviationY` Nullable(Decimal(18, 4)),
    `frontShieldPitchAngle` Nullable(Decimal(18, 4)),
    `frontShieldRollAngle` Nullable(Decimal(18, 4)),
    `leftShieldPressure` Nullable(Decimal(18, 4)),
    `rightShieldPressure` Nullable(Decimal(18, 4)),
    `topShieldPressure` Nullable(Decimal(18, 4))
)
ENGINE = Kafka()
SETTINGS
  kafka_broker_list = 'datanode1:9092,datanode2:9092,namenode:9092',
  kafka_topic_list = 'sxsddsj_shield_online_data_all_in_one_4_1',
  kafka_group_name = 'sxsddsj-shield-online-data-all-in-one-4-1-ck',
  kafka_format = 'JSONEachRow',
  kafka_num_consumers = 1;
```

> 其中`kafka_broker_list`需要根据生产环境配置更改

3. clickhouse创建传输视图

```sql
CREATE MATERIALIZED VIEW sxsddsj.shield_online_data_all_in_one_4_1_mv to sxsddsj.shield_offline_data_all_in_one_4_1
as select * from sxsddsj.shield_online_data_all_in_one_4_1_kafka;
```



4. 发布微服务`sxsddsj-shield-online-data-collector`



```
kafka-topics.sh --create --topic sxsddsj_shield_online_data_all_in_one_4_1 --bootstrap-server localhost:9092 --partitions 3 --replication-factor 1

```





```
SHOW CREATE TABLE sxsddsj.shield_online_data_all_in_one_4_1_mv;

```

```
kafka-console-consumer --bootstrap-server datanode2:9092 --topic sxsddsj_shield_online_data_all_in_one_4_1 --from-beginning

```

```
kafka-console-consumer.sh --bootstrap-server your_bootstrap_server --topic sxsddsj_shield_online_data_all_in_one_4_1 --from-beginning

```


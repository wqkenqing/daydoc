结合现有的工作中涉及到了一些组件的安装、运维、监听等功能。

---

对现在功能进行总结、优化、改写。

---

已实现在的功能有

1. 备份功能

   1. 所涉组件

      1. es
      2. clickhouse
      3. kafka

   2. 所涉脚本

      1. archive.sh

         1. ```
            #!/bin/bash
            
            ## 生成日志时间后缀
            date_suffix=$(date +"%Y%m%d%%h%M%s")
            
            ## 初始化数据备份地址
            archive_dir=/data/backup/$1
            
            ## 将$2指定地址备份为$1_$date_suffix.tar.gz
            
            tar -cvf $archive_dir/$1_$date_suffix.tar.gz $2
            
            file_count=$(ls -1 "$archive_dir" | wc -l)
            
            # 如果文件数量大于7，则删除最旧的文件
            if [ "$file_count" -gt 7 ]; then
                # 列出归档目录中的所有文件，并按修改时间升序排序
                files_to_delete=($(ls -1t "$archive_dir"))
            
                # 循环删除多余的文件，只保留最新的七个
                for ((i=${#files_to_delete[@]}-1; i>=7; i--)); do
                    file_to_delete="$archive_dir/${files_to_delete[i]}"
                    rm "$file_to_delete"
                    echo "Deleted: $file_to_delete"
                done
            fi
            ```

         2. monitor.sh

            1. 这个脚本的用处主要是因为封装的flume任务无法感知到它的数据采集是否还存活。所以通过反向检测对应topic的offset值的变化，来确认采集任务是否存活。

            2. ```
               #!/bin/bash
               source /etc/profile
               /opt/jdk1.8/bin/java -cp /data/run/monitor/monitor-1.0-SNAPSHOT-jar-with-dependencies.jar  Monitor /data/run/monitor/smap.txt /data/run/monitor/second/topics /data/run/monitor/second/result.txt /data/run/monitor/second/status.txt
               ```

         3. zk_check.sh

            1. 这个脚本一个是监听zookeeper，另一个是监听flink

            2. ```
               #!/bin/bash
               export JAVA_HOME=/opt/jdk1.8
               export SCALA_HOME=/opt/scala2.11
               export KAFKA_HOME=/opt/kafka2.2.1
               export ZOOKEEPER_HOME=/opt/zookeeper3.4.5
               export FLUME_HOME=/opt/flume1.9.0
               #export FLUME_HOME=/root/flume-ng
               export FLINK_HOME=/opt/flink1.12.4
               export PATH=$PATH:$JAVA_HOME/bin:$SCALA_HOME/bin:$KAFKA_HOME/bin:$ZOOKEEPER_HOME/bin:$FLUME_HOME/bin:$FLINK_HOME/bin
               
               # 获取所有进程名称
               process=$(jps | awk '{print $2}')
               
               # 初始化计数器
               flink_cli=0
               flink_manage=0
               zk=0
               
               # 遍历所有进程名称
               for p in $process
               do
                   if [ "$p" = "CliFrontend" ]; then
                       flink_cli=$((flink_cli + 1))
                   elif [ "$p" = "StandaloneSessionClusterEntrypoint" ]; then
                       flink_manage=$((flink_manage + 1))
                   elif [ "$p" = "QuorumPeerMain" ]; then
                       zk=$((zk + 1))
                   fi
               done
               
               if [ $zk = 0 ];then
               /opt/zookeeper3.4.5/bin/zkServer.sh start
               echo "ZOOKEEPER is restart!"
               fi
               
               if [ $flink_manage = 0 ]
               then
               /opt/flink1.12.4/bin/start-cluster.sh
               
               echo "flink is restarted !"
               
               /data/flink_job/run.sh
               
               echo "flink_job is restarted!"
               
               fi
               # 打印计数结果
               echo "Flink CLI processes: $flink_cli"
               echo "Flink Manager processes: $flink_manage"
               echo "ZooKeeper processes: $zk"
               ```

						3.  这里要考虑flink 任务的监听与优化

---

